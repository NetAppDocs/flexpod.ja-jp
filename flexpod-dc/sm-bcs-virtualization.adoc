---
sidebar: sidebar 
permalink: flexpod-dc/sm-bcs-virtualization.html 
keywords: network connectivity, virtual networking, vm-host, affinity, groups, rules, vsphere ha heartbeat 
summary: マルチサイトの FlexPod SM-BC 解決策 では、 1 つの VMware vCenter が解決策 全体の仮想インフラストラクチャリソースを管理します。両方のデータセンターのホストは、両方のデータセンターにまたがる単一の VMware HA クラスタに参加します。ホストは、 NetApp SM-BC 解決策 にアクセスできます。このでは、定義済みの SM-BC 関係にあるストレージに両方のサイトからアクセスできます。 
---
= 解決策 の検証：仮想化
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../media/


link:sm-bcs-storage.html["前のバージョン：解決策 の検証 - ストレージ。"]

マルチサイトの FlexPod SM-BC 解決策 では、 1 つの VMware vCenter が解決策 全体の仮想インフラストラクチャリソースを管理します。両方のデータセンターのホストは、両方のデータセンターにまたがる単一の VMware HA クラスタに参加します。ホストは、 NetApp SM-BC 解決策 にアクセスできます。このでは、定義済みの SM-BC 関係にあるストレージに両方のサイトからアクセスできます。

SM-BC 解決策 ストレージは、災害やダウンタイムを避けるために、 VMware vSphere Metro Storage Cluster （ vMSC ）機能の統一されたアクセスモデルに準拠しています。仮想マシンのパフォーマンスを最適化するには、通常運用時の WAN リンク経由のレイテンシとトラフィックを最小限に抑えるために、仮想マシンディスクをローカルの NetApp AFF A250 システム上にホストする必要があります。

設計実装の一環として、 2 つのサイト間での仮想マシンの分散を決定する必要があります。この仮想マシンサイトのアフィニティとアプリケーションの 2 つのサイト間での分散は、サイトの設定とアプリケーションの要件に応じて決定できます。VMware クラスタの VM/ ホストグループおよび VM/ ホストルールを使用して、 VM/ ホストアフィニティを設定し、 VM が目的のサイトのホストで実行されていることを確認します。

ただし、両方のサイトで VM を実行できる構成では、リモートサイトのホストで VMware HA によって VM を再起動し、解決策 の耐障害性を確保できます。両方のサイトで仮想マシンを実行する場合は、サイト間で仮想マシンの vMotion を円滑に実行するために、すべての ESXi ホストに iSCSI 共有データストアをマウントする必要があります。

次の図は、 FlexPod SM-BC 解決策 の仮想化ビューの概要を示しています。このビューには、 VMware HA と vMSC の両方の機能が含まれており、コンピューティングサービスとストレージサービスの高可用性を実現します。アクティブ / アクティブのデータセンター解決策 アーキテクチャにより、サイト間でのワークロードの移動が可能になり、 DR / BC 保護が提供されます。

image:sm-bcs-image39.png["エラー：グラフィックイメージがありません"]



== エンドツーエンドのネットワーク接続

FlexPod SM-BC 解決策 には、各サイトに FlexPod インフラストラクチャ、サイト間のネットワーク接続、および 3 番目のサイトに導入された ONTAP メディエーターが含まれており、必要な RPO と RTO の目標を達成します。次の図に、各サイトの Cisco UCS B200M5 サーバと、サイト内およびサイト間の SM-BC 機能を備えたネットアップストレージとのエンドツーエンドのネットワーク接続を示します。

image:sm-bcs-image40.png["エラー：グラフィックイメージがありません"]

FlexPod の導入アーキテクチャは、この解決策 検証で各サイトで同じです。ただし、解決策 は非対称型の導入をサポートしており、要件を満たす既存の FlexPod ソリューションに追加することもできます。

拡張レイヤ 2 アーキテクチャは、各データセンターにおけるポートチャネルの Cisco UCS コンピューティングとネットアップストレージの間の接続、およびデータセンター間の接続を提供する、シームレスなマルチサイトデータファブリックに使用されます。ポートチャネルの構成、および必要に応じて仮想ポートチャネルの構成は、コンピューティングレイヤ、ネットワークレイヤ、ストレージレイヤ間の帯域幅集約とフォールトトレランス、およびクロスサイトリンクに使用されます。その結果、 UCS ブレードサーバは、ローカルとリモートの両方のネットアップストレージに接続され、マルチパスアクセスを提供します。



== 仮想ネットワーク

クラスタ内の各ホストは、場所に関係なく同一の仮想ネットワークを使用して導入されます。この設計では、 VMware 仮想スイッチ（ vSwitch ）と VMware 仮想分散スイッチ（ vDS ）を使用して、さまざまなトラフィックタイプを分離しています。VMware vSwitch は主に FlexPod インフラネットワーク用、 vDS はアプリケーションネットワーク用ですが、必須ではありません。

仮想スイッチ（ vSwitch 、 vDS ）は、仮想スイッチごとに 2 つのアップリンクで展開されます。 ESXi ハイパーバイザーレベルのアップリンクは、 Cisco UCS ソフトウェアでは vmnic および仮想 NIC （ vNIC ）と呼ばれます。vNIC は、 Cisco UCS サービスプロファイルを使用して、各サーバの Cisco UCS VIC アダプタ上に作成されます。次の図に示すように、 6 つの vNIC が定義され、 vSwitch0 に 2 つ、 vDS0 に 2 つ、 vSwitch1 に 2 つ、 iSCSI アップリンクに 2 つです。

image:sm-bcs-image41.png["エラー：グラフィックイメージがありません"]

vSwitch0 は VMware ESXi ホストの設定中に定義され、管理用に FlexPod インフラ管理 VLAN と ESXi ホスト VMkernel （ VMK ）ポートが含まれています。インフラ管理仮想マシンポートグループも、必要な重要なインフラ管理仮想マシン用の vSwitch0 に配置されます。

このような管理インフラストラクチャ仮想マシンは、 vDS ではなく vSwitch0 に配置することが重要です。これは、 FlexPod インフラストラクチャがシャットダウンまたは電源の再投入された場合に、その管理仮想マシンが最初に実行されていたホスト以外のホストで、仮想マシンをアクティブ化しようとするためです。 vSwitch0 のネットワークで正常にブートします。このプロセスは、 VMware vCenter が管理仮想マシンである場合は特に重要です。vCenter が vDS 上にあり、別のホストに移動してブートした場合、起動後にネットワークに接続されません。

この設計では、 2 つの iSCSI ブート vSwitch を使用します。Cisco UCS iSCSI ブートには、 iSCSI ブート用に個別の vNIC が必要です。これらの vNIC は、適切なファブリックの iSCSI VLAN をネイティブ VLAN として使用し、適切な iSCSI ブート vSwitch に接続されます。また、新しい vDS を導入するか、既存の vDS を使用して、 vDS に iSCSI ネットワークを導入することもできます。



== VM とホストのアフィニティグループとルール

両方の SM-BC サイトで任意の ESXi ホスト上で仮想マシンを実行できるようにするには、すべての ESXi ホストが両方のサイトから iSCSI データストアをマウントする必要があります。両方のサイトのデータストアがすべての ESXi ホストで適切にマウントされている場合は、 vMotion を使用するすべてのホスト間で仮想マシンを移行しても、それらのデータストアから作成されたすべての仮想ディスクへのアクセスは維持されます。

ローカルデータストアを使用する仮想マシンの場合、仮想ディスクがリモートサイトのホストに移行されると、仮想ディスクへのアクセスがリモートになり、サイト間の物理的な距離による読み取り処理のレイテンシが増加します。そのため、ローカルホストに仮想マシンを保持し、サイトでローカルストレージを利用することを推奨します。

VM とホストのアフィニティメカニズムを使用すると、 VM / ホストグループを作成して、特定のサイトに配置された仮想マシンとホストの VM グループとホストグループを作成できます。VM/ ホストルールを使用して、 VM とホストが従うポリシーを指定できます。サイトのメンテナンスまたは災害時にサイト間で仮想マシンを移行できるようにするには、その柔軟性のため、「グループ内のホストで実行する」ポリシー仕様を使用します。

次のスクリーンショットは、サイト A とサイト B のホストおよび VM について、 2 つのホストグループと 2 つの VM グループが作成されたことを示しています

image:sm-bcs-image42.png["エラー：グラフィックイメージがありません"]

さらに、次の 2 つの図は、「グループ内のホストで実行する必要があります」ポリシーを使用して、サイト A およびサイト B の VM がそれぞれのサイトのホストで実行されるように作成された VM/ ホストルールを示しています。

image:sm-bcs-image43.png["エラー：グラフィックイメージがありません"]

image:sm-bcs-image44.png["エラー：グラフィックイメージがありません"]



== vSphere HA ハートビート

VMware vSphere HA は、ホストの状態を検証するためのハートビートメカニズムを備えています。一次ハートビートメカニズムはネットワーク経由で行われ、二次ハートビートメカニズムはデータストアを経由します。ハートビートを受信しない場合は、デフォルトゲートウェイに ping を送信するか、手動で設定した隔離アドレスに基づいて、ハートビートをネットワークから隔離するかを決定します。データストアのハートビートでは、ストレッチクラスタのハートビートデータストアを最小構成から 4 つに増やすことを推奨します。

解決策 の検証では、 2 つの ONTAP クラスタ管理 IP アドレスを隔離アドレスとして使用します。また、次の図に示すように、推奨される vSphere HA の詳細オプション「 DS.heartbeatDsPerHost 」の値が 4 に追加されました。

image:sm-bcs-image45.png["エラー：グラフィックイメージがありません"]

ハートビートデータストアの場合、クラスタから 4 つの共有データストアを指定し、次の図に示すようにそれを補完します。

image:sm-bcs-image46.png["エラー：グラフィックイメージがありません"]

VMware HA Cluster および VMware vSphere Metro ストレージクラスタのその他のベストプラクティスおよび設定については、を参照してください https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.avail.doc/GUID-5432CA24-14F1-44E3-87FB-61D937831CF6.html["vSphere HA クラスタを作成および使用する"^]、 https://core.vmware.com/resource/vmware-vsphere-metro-storage-cluster-vmsc["VMware vSphere Metro Storage Cluster （ vMSC ）"^] およびの VMware KB です https://kb.vmware.com/s/article/83370["NetApp ONTAP と NetApp SnapMirror のビジネス継続性（ SM-BC ）および VMware vSphere Metro Storage Cluster （ vMSC ）"^]。

link:sm-bcs-validated-scenarios.html["次：解決策 の検証済みのシナリオ"]
